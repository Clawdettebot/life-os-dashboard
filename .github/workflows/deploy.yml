name: Life OS Dashboard CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: dashboard/package.json
    
    - name: Install Backend Dependencies
      working-directory: ./dashboard
      run: npm ci
    
    - name: Install Frontend Dependencies
      working-directory: ./dashboard/client
      run: npm ci
    
    - name: Build Frontend
      working-directory: ./dashboard/client
      run: npm run build
    
    - name: Copy Assets to Build
      working-directory: ./dashboard
      run: |
        cp -r assets/wallpapers client/build/ 2>/dev/null || true
        cp -r assets/emojis client/build/ 2>/dev/null || true
    
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: dashboard-build
        path: |
          dashboard/
          !dashboard/node_modules/
          !dashboard/client/node_modules/

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
    
    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        VPS_PATH: ${{ secrets.VPS_PATH }}
      run: |
        echo "ðŸš€ Deploying to VPS..."
        
        # SSH into VPS and deploy
        ssh $VPS_USER@$VPS_HOST << 'EOF'
          cd $VPS_PATH
          
          # Pull latest code
          git pull origin main
          
          # Install backend dependencies
          npm install
          
          # Build frontend
          cd client
          npm install
          npm run build
          cd ..
          
          # Copy assets
          cp -r assets/wallpapers client/build/ 2>/dev/null || true
          cp -r assets/emojis client/build/ 2>/dev/null || true
          
          # Restart the server (using pm2 or direct node)
          if command -v pm2 &> /dev/null; then
            pm2 restart dashboard || pm2 start server.js --name dashboard
          else
            pkill -f "node server.js" || true
            sleep 2
            nohup node server.js > dashboard.log 2>&1 &
          fi
          
          echo "âœ… Deployment complete!"
        EOF
